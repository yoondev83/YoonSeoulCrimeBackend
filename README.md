# YoonSeoulCrimeBackend
### [Front-end page (ÌîÑÎ°†Ìä∏ÏóîÎìú ÌéòÏù¥ÏßÄ)](https://github.com/yoondev83/YoonSeoulCrimeFront)

## Installation (ÏÑ§Ïπò)
```javascript
npm install
npx nodemon ./app.js
```
### Project Period (ÌîÑÎ°úÏ†ùÌä∏ Í∏∞Í∞Ñ) : September 2021 - October 2021
## Back-end Structure (Î∞±ÏóîÎìú )Íµ¨Ï°∞
```
üì¶ 
.gitignore
app.js
config
‚îÇ¬†¬†‚îú‚îÄ¬†key.js
‚îÇ¬†¬†‚îú‚îÄ¬†passport.js
‚îÇ¬†¬†‚îî‚îÄ¬†prod.js
‚îú‚îÄ¬†model
‚îÇ¬†¬†‚îú‚îÄ¬†article.js
‚îÇ¬†¬†‚îî‚îÄ¬†user.js
‚îú‚îÄ¬†package-lock.json
‚îú‚îÄ¬†package.json
‚îî‚îÄ¬†routes
¬†¬†¬†‚îî‚îÄ¬†main.js
```
¬©generated by [Project Tree Generator](https://woochanleee.github.io/project-tree-generator)

### Environment Í∞úÎ∞úÌôòÍ≤Ω
+ Operating System: Win 10
+ IDE: VSCode
+ Front-end: React 17.0.2, Material-ui 4.12, chart.js 3.51, leaflet: 1.7.1, react-leaflet: 3.2.1
+ Back-end: Express: 4.17, mongoose: 6.0.8, passport: 0.5, passport-local: 1.0, passport-local-mongoose: 6.1, bcrypt: 5.0.1

## Main Features ÌîÑÎ°úÏ†ùÌä∏ Í∏∞Îä•
1. Mongoose
2.	Passport.js
3.	Bcrypt

## Code
### Explanations are written between codes as comments and Korean comments are written between components below.

### ÏòÅÎ¨∏ ÏÑ§Î™ÖÏùÄ Ï£ºÏÑù ÌòïÏãùÏúºÎ°ú Îã¨ÏïÑÎëêÏóàÏúºÎ©∞ ÌïúÍµ≠Ïñ¥ ÏÑ§Î™ÖÏùÄ Í∞Å Ïª¥Ìè¨ÎÑåÌä∏ ÏÇ¨Ïù¥Ïóê Ï†ÅÏñ¥ ÎëêÏóàÏäµÎãàÎã§.

#### app.js
```javascript
const express   =   require("express");
const app       =   express();
const port      =   process.env.PORT || 5000;
const mongoose  =   require("mongoose");
const config    =   require("./config/key");
const session   =   require("express-session");
const passport  =   require("./config/passport");
const cors      =   require("cors");

mongoose.connect(config.MONGODB_URI)
.then(() => {console.log("DB is connected")})
.catch(err => console.log(err));

app.use(express.json());
app.use(express.urlencoded({extended:true}));
app.set("trust proxy", 1);
app.use(session({
    secret: config.PASS_SECRET,
    resave: false,
    saveUninitialized: false
}));
app.use(passport.initialize());
app.use(passport.session());
app.use("/", require("./routes/main"));

app.listen(port, () => console.log(`Server has started on ${port}`));
```
#### routes/main.js
```javascript
const router        =   require("express").Router();
const passport      =   require("../config/passport");
const bcrypt        =   require("bcrypt");
const saltRounds    =   10;
const {User}        =   require("../model/user");
const {Article}     =   require("../model/article");

router.get("/", (req, res) => {
    res.send("Welcome!");
});


//--------------------------Sign up---------------------------------
router.route("/api/signup")
.post((req, res) => {
    const userId    =   req.body.userMemberId;
    const userEmail =   req.body.userMemberEmail;
    const userPass  =   req.body.userMemberPass;
    res.header("Access-Control-Allow-Origin", "*");
    bcrypt.hash(userPass, saltRounds, (err, hash) => {
        User.register(new User({username: userId, userId: userId, email: userEmail, password: hash}), userPass, (err, registeredUser) => {
            if(err){
                console.log(err);
                return res.json({
                    registration: false
                });
            }else{
                passport.authenticate("local")(req, res, () =>{
                    return res.json({
                        registration: true,
                    });
                })
            }
        });
    });
});

//--------------------------Sign in---------------------------------
router.route("/api/signin")
.post((req, res) => {
    const loginUser     =   new User({
        userEmail: req.body.userMemberEmail,
        password: req.body.userMemberPass,
    });
    User.findOne({email: req.body.userMemberEmail}, (err, foundUser) => {
        if(err){
            console.log(err);
        }else{
            if(!foundUser){
                return res.json({
                    loginSuccess: false,
                });
            }else{
                bcrypt.compare(req.body.userMemberPass, foundUser.password, (err, result) =>{
                    if (result === true){
                        req.login(loginUser, err=>{
                            if(err){
                                console.log(err);
                                return res.json({
                                    login: false,
                                });
                            }else{
                                passport.authenticate("local")(req, res, () =>{
                                    req.session.userId   = foundUser.userId;
                                    req.session.userEmail= foundUser.email;
                                    return res.json({
                                        authentication: true,
                                        userId: req.session.userId,
                                        userEmail: req.session.userEmail,
                                    });
                                })
                            }
                        });
                    }else{
                        console.log(err);
                        return res.json({
                            loginSuccess: false,
                        });
                    }
                });
            }
        }
    });
})


// ---------------- Email Validation Check ------------------------
router.route("/api/signup/check/email")
.post((req, res) => {
    const userEmail =   req.body.userMemberEmail;
    User.findOne({email: userEmail}, (err, foundUser) => {
        if(err){
            console.log(err);
        }else{
            if(foundUser){
                return res.json({
                    validation: false,
                });
            }else{
                return res.json({
                    validation: true,
                });
            }
        }
    });
});
// ------------------ ID Validation Check ------------------------
router.route("/api/signup/check/id")
.post((req, res) => {
    const userId    =   req.body.userMemberId;
    User.findOne({userId: userId}, (err, foundUser) => {
        if(err){
            console.log(err);
        }else{
            if(foundUser){
                return res.json({
                    validation: false,
                });
            }else{
                return res.json({
                    validation: true,
                });
            }
        }
    });
});
//--------------------------Auth Check---------------------------------
router.route("/checkAuthentication")
.get((req, res) => {
    res.header("Access-Control-Allow-Origin", "*");
    const isAuth     = req.isAuthenticated("local");
    const userId    = req.session.userId;
    const userEmail = req.session.userEmail;
    return res.json({
        isAuth,
        userId,
        userEmail,
    });
  });
//--------------------------Logout---------------------------------
router.route("/api/logout")
.post((req, res) => {
    if(req.isAuthenticated()){
        res.clearCookie("connect.sid");
        req.logOut(err => {
            res.json({
                logout: false,
            });
        });
        req.session.destroy();
        res.send("You're logged out");
    }else{
        res.send("Please, login first.");
    }
});
//--------------------------Delete Account---------------------------------
router.route("/api/account/removal")
.post((req, res) => {
    User.findOne({email: req.body.userEmail}, (err, foundUser) => {
        if(err){
            console.log(err);
        }else{
            if(!foundUser){
                return res.json({
                    accountRemoval: false,
                });
            }else{
                User.findOneAndRemove({email: foundUser.email}, err=>{
                    if(err){
                        console.log("Delete failed");
                    }else{
                        console.log("Delete Successfully!");
                    }
                });
            }
        }
    });
});
//--------------------------Change Password---------------------------------
router.route("/api/account/change")
.patch((req, res) => {
    User.findOne({email: req.body.userEmail}, (err, foundUser) => {
        if(err){
            console.log(err);
        }else{
            if(!foundUser){
                return res.json({
                    passChange: false,
                });
            }else{
                bcrypt.hash(req.body.userPass, saltRounds, (err, hash) => {
                    User.findOneAndUpdate({email: foundUser.email}, {$set: {password: hash}}, err=>{
                        if(err){
                            console.log("Change failed");
                        }else{
                            res.json({
                                change: "success"
                            });
                        }
                    });
                });
            }
        }
    });
});
//--------------------------Board---------------------------------
router.route("/api/board/boardlist")
.get((req, res) => {
    res.header("Access-Control-Allow-Origin", "*");
    Article.find((err, articles) => {
        if(err){
            console.log("Oops! Something went wrong.");
        }else{
           res.send(articles);
        }
    });
})
.post((req, res) => {
    if(req.isAuthenticated()){
        const articleData = new Article({
            userId: req.body.userId,
            title:req.body.title,
            content: req.body.content,
            heart: 0,
            brokenheart: 0,
        });
        articleData.save()
        .then(res.send("Article has successfully added"))
        .catch(err => console.log(err));
    }else{
        res.send("Please, login first.");
    };
})
.patch((req, res) => {
    if(JSON.stringify(req.body).includes("heart")){
        Article.updateOne({articleNum: req.body.postNum}, {$set:{heart:req.body.heart}}, err =>{
            if(!err){
                res.send("Successfully updated article");
            }else{
                res.send("Failed to update");
            }
        });
    }else{
        Article.updateOne({articleNum: req.body.postNum}, {$set:{brokenheart:req.body.brokenHeart}}, err =>{
            if(!err){
                res.send("Successfully updated article");
            }else{
                res.send("Failed to update");
            }
        });
    }
});

```
#### model/article.js
```javascript
const mongoose      =   require("mongoose");
const autoIncrement =   require("mongoose-auto-increment");

autoIncrement.initialize(mongoose.connection);
const articleSchema =   mongoose.Schema({
    articleNum:{
        type: Number,
        unique:true,
        index:true,
    },
    userId:{
        type: String,
        maxlength: 20,
    },
    title:  {
        type: String
    }, // String is shorthand for {type: String}
    content:{
        type: String,
        maxlength: 5000,
    },
    date: { 
        type: Date, 
        default: Date.now
    },
    heart: {
        type: Number,
        default: 0
    },
    brokenheart: {
        type: Number,
        default: 0
    },
    hidden: Boolean,

});

articleSchema.plugin(autoIncrement.plugin,{
	model : 'articleModel',
	field : 'articleNum',
	startAt : 1, //ÏãúÏûë 
	increment : 1 // Ï¶ùÍ∞Ä
});

const Article      =   mongoose.model("Article", articleSchema);
```
#### model/user.js
```javascript
const mongoose              =   require("mongoose");
const passportLocalMongoose =   require("passport-local-mongoose");
const userSchema            =   mongoose.Schema({
    userId:{
        type: String,
        maxlength: 20,
        unique: true,
        required: true,
    },
    email:{
        type: String,
        trim: true,
        index: true,
        unique: true,
        required: true,
    },
    password: {
        type: String,
        minlength: 5,
        required: true,
    },
    role: {
        type: Number,
        default: 0
    },
    token: {
        type: String,
    },
    tokenExp: {
        type: Number,
    },
});
userSchema.plugin(passportLocalMongoose);
const User      =   mongoose.model("User", userSchema);
```
